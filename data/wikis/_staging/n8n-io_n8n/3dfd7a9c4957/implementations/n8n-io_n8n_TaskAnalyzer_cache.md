# Implementation: TaskAnalyzer Cache Methods

{| class="wikitable" style="float:right; margin-left:1em; width:300px;"
|-
! Knowledge Sources
|
* [[source::Repo|n8n|https://github.com/n8n-io/n8n]]
|-
! Domains
| [[domain::Security]], [[domain::Caching]]
|-
! Last Updated
| [[last_updated::2024-12-18 12:00 GMT]]
|}

== Overview ==

Concrete methods for generating cache keys and managing the validation result cache in TaskAnalyzer.

=== Description ===

The cache implementation uses:

1. **`_to_cache_key()`**: Generates a cache key from code and security allowlists
   - SHA-256 hash of code string
   - Sorted tuples of stdlib_allow and external_allow
   - Returns `CacheKey` tuple for dictionary lookup

2. **`_set_in_cache()`**: Stores validation result with FIFO eviction
   - Evicts oldest entry if cache at `MAX_VALIDATION_CACHE_SIZE` (500)
   - Copies violations list to prevent mutation issues
   - Moves entry to end for LRU-like access tracking

3. **Class-level `_cache`**: `OrderedDict` shared across all `TaskAnalyzer` instances

=== Usage ===

These methods are called internally by `validate()`. The cache is class-level, so validation results persist across multiple `TaskAnalyzer` instances with the same policy.

== Code Reference ==

=== Source Location ===
* '''Repository:''' [https://github.com/n8n-io/n8n n8n]
* '''File:''' packages/@n8n/task-runner-python/src/task_analyzer.py
* '''Lines:''' L203-212

=== Signature ===
<syntaxhighlight lang="python">
CacheKey = tuple[str, tuple]  # (code_hash, allowlists_tuple)
CachedViolations = list[str]
ValidationCache = OrderedDict[CacheKey, CachedViolations]

class TaskAnalyzer:
    _cache: ValidationCache = OrderedDict()  # Class-level shared cache

    def _to_cache_key(self, code: str) -> CacheKey:
        """
        Generate cache key from code and security allowlists.

        Args:
            code: Python source code string.

        Returns:
            Tuple of (code_sha256_hex, (stdlib_tuple, external_tuple)).
        """

    def _set_in_cache(self, cache_key: CacheKey, violations: CachedViolations) -> None:
        """
        Store validation result in cache with FIFO eviction.

        Args:
            cache_key: Key generated by _to_cache_key().
            violations: List of violation strings (empty list if clean).
        """
</syntaxhighlight>

=== Import ===
<syntaxhighlight lang="python">
from src.task_analyzer import TaskAnalyzer
</syntaxhighlight>

== I/O Contract ==

=== _to_cache_key ===
{| class="wikitable"
|-
! Input !! Type !! Description
|-
| code || str || Python source code to hash
|}

{| class="wikitable"
|-
! Output !! Type !! Description
|-
| (returns) || CacheKey || Tuple of (sha256_hex, (stdlib_tuple, external_tuple))
|}

=== _set_in_cache ===
{| class="wikitable"
|-
! Input !! Type !! Description
|-
| cache_key || CacheKey || Key from _to_cache_key()
|-
| violations || CachedViolations || List of violation strings
|}

{| class="wikitable"
|-
! Side Effect !! Description
|-
| _cache modified || Entry added, oldest evicted if at limit
|}

== Usage Examples ==

=== Cache Key Generation ===
<syntaxhighlight lang="python">
import hashlib

# Given this code and config
code = "import json\nreturn json.dumps(data)"
analyzer = TaskAnalyzer(security_config)

# Cache key is generated as:
code_hash = hashlib.sha256(code.encode()).hexdigest()
# e.g., "a1b2c3d4..."

allowlists = (
    tuple(sorted(analyzer._security_config.stdlib_allow)),  # ('datetime', 'json', 're')
    tuple(sorted(analyzer._security_config.external_allow)),  # ()
)

cache_key = (code_hash, allowlists)
# ('a1b2c3d4...', (('datetime', 'json', 're'), ()))
</syntaxhighlight>

=== Cache Behavior ===
<syntaxhighlight lang="python">
# First validation - cache miss
analyzer.validate(code)  # Parses AST, stores result

# Second validation - cache hit
analyzer.validate(code)  # Returns immediately from cache

# Different policy - cache miss (different key)
new_analyzer = TaskAnalyzer(different_security_config)
new_analyzer.validate(code)  # New key due to different allowlists
</syntaxhighlight>

=== Cache Eviction ===
<syntaxhighlight lang="python">
# Cache eviction at capacity
MAX_VALIDATION_CACHE_SIZE = 500

# When 500th unique code+policy validated:
# - Oldest entry (first in OrderedDict) is removed
# - New entry added at end
# - Total entries stays at 500
</syntaxhighlight>

== Related Pages ==

=== Implements Principle ===
* [[implements::Principle:n8n-io_n8n_Validation_Caching]]

=== Requires Environment ===
* [[requires_env::Environment:n8n-io_n8n_Python_Task_Runner_Env]]
