# Wiki Service - serves wiki files from data/wikis
# Usage: docker compose up -d
# Access: http://localhost:${WIKI_PORT:-8080}
#
# Environment variables:
#   WIKI_DIR - Path to wiki data directory (relative to project root)
#              Default: data/wikis

services:
  db:
    image: mariadb:11
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-localroot123}
      MYSQL_DATABASE: ${MW_DB_NAME:-wiki}
      MYSQL_USER: ${MW_DB_USER:-mediawiki}
      MYSQL_PASSWORD: ${MW_DB_PASSWORD:-localpass123}
    volumes:
      - dbdata:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  wiki:
    build: ./mediawiki
    image: wiki-service:latest
    environment:
      MW_DB_HOST: db
      MW_DB_NAME: ${MW_DB_NAME:-wiki}
      MW_DB_USER: ${MW_DB_USER:-mediawiki}
      MW_DB_PASSWORD: ${MW_DB_PASSWORD:-localpass123}
      MW_SITE_SERVER: http://localhost:${WIKI_PORT:-8080}
      MW_SITENAME: ${MW_SITENAME:-Local Wiki}
      MW_LANG: ${MW_LANG:-en}
      MW_ADMIN_USER: ${MW_ADMIN_USER:-admin}
      MW_ADMIN_PASS: ${WIKI_ADMIN_PASSWORD:-adminpass123}
      MW_AGENT_USER: ${MW_AGENT_USER:-agent}
      MW_AGENT_PASS: ${WIKI_AGENT_PASSWORD:-agentpass123}
      MW_CREATE_AGENT: "true"
      # SMTP settings (optional, for password reset emails)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-}
      SMTP_AUTH: ${SMTP_AUTH:-true}
    ports:
      - "${WIKI_PORT:-8080}:80"
    volumes:
      - ./images:/var/www/html/images
      - ../../${WIKI_DIR:-data/wikis}:/wikis:rw
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/api.php?action=query&meta=siteinfo&format=json"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  wiki-sync:
    build:
      context: .
      dockerfile: sync/Dockerfile
    environment:
      WIKI_URL: http://wiki:80
      WIKI_DIR: /wikis
      SYNC_STATE: /state/sync.json
      MW_USER: ${MW_AGENT_USER:-agent}
      MW_PASS: ${WIKI_AGENT_PASSWORD:-agentpass123}
      POLL_INTERVAL: ${SYNC_POLL_INTERVAL:-30}
      DEBOUNCE_MS: ${SYNC_DEBOUNCE_MS:-500}
      CONFLICT_MODE: ${SYNC_CONFLICT_MODE:-file}
      DELETE_MODE: ${SYNC_DELETE_MODE:-log}
    volumes:
      - ../../${WIKI_DIR:-data/wikis}:/wikis:rw
      - ./state:/state:rw
    depends_on:
      wiki:
        condition: service_healthy
    restart: unless-stopped

volumes:
  dbdata:

